name: Build, Test, Publish
run-name: >-
  ${{
    (github.event_name == 'pull_request' &&
      format('ðŸ”€ PR #{0} ({1}) by @{2}', github.event.number, github.event.pull_request.title, github.actor)) ||
    (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v') &&
      format('ðŸ“¦ Release {0} by @{1}', github.ref_name, github.actor)) ||
    (github.event_name == 'push' &&
      format('ðŸ§± Push to {0} by @{1} ({2})', github.ref_name, github.actor, github.event.head_commit.message)) ||
    (github.event_name == 'workflow_dispatch' &&
      format('ðŸ‘Œ Manual run by @{0}', github.actor)) ||
    'Build, Test, Publish'
  }}

on:
  workflow_dispatch:
    inputs:
      publish-myget:
        description: Publish packages to MyGet (auto = on push to main)
        type: choice
        options: [ 'auto', 'yes', 'no' ]
        default: 'auto'
        required: true
      publish-nuget:
        description: Publish packages to NuGet (auto = on push to v* tag)
        type: choice
        options: [ 'auto', 'yes', 'no' ]
        default: 'auto'
        required: true
      publish-log:
        description: Publish MSBuild binary log to artifacts (auto = on build failure)
        type: choice
        options: [ 'auto', 'yes', 'no' ]
        default: 'auto'
        required: true
  push:
    branches:
      - main
      - feature/**
    tags:
      - v*
  pull_request:
    branches:
      - main

env:
  # options
  dotnet_test_versions_core: '6 7 8 9 10'
  dotnet_test_versions_win: '462'
  artifacts_dir: Artifacts
  logs_dir:      Artifacts/logs
  packages_dir:  Artifacts/packages
  tests_dir:     Artifacts/tests

  # arguments
  publish_myget: ${{ inputs.publish-myget || 'auto' }}
  publish_nuget: ${{ inputs.publish-nuget || 'auto' }}
  publish_log:   ${{ inputs.publish-log   || 'auto' }}
  # dotnet options
  SuppressNETCoreSdkPreviewMessage: true
  DOTNET_SYSTEM_CONSOLE_ALLOW_ANSI_COLOR_REDIRECTION: true
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true
  DOTNET_NOLOGO: true

defaults:
  run:
    shell: pwsh

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      version-suffix: ${{ steps.git-version.outputs.version-suffix }}
      release-url:    ${{ steps.git-version.outputs.release-url }}
      release-meta:   ${{ steps.git-version.outputs.release-meta }}
      release-notes:  ${{ steps.git-version.outputs.release-notes }}
      prerelease:     ${{ steps.git-version.outputs.prerelease }}
      publish-myget:  ${{ steps.next.outputs.publish-myget }}
      publish-nuget:  ${{ steps.next.outputs.publish-nuget }}
      publish-log:    ${{ steps.next.outputs.publish-log }}

    steps:
    - name: Checkout Git repository (deep)
      uses: actions/checkout@v5
      with:
        fetch-depth: 0
        filter: tree:0
        submodules: true
        show-progress: false

    - name: Setup environment
      uses: ./.github/actions/setup
      with:
        dotnet-version: 10
        dotnet-runtime: sdk

    - name: Calculate version properties
      uses: ./.github/actions/git-version
      id: git-version

    - name: Cache NuGet packages
      uses: actions/cache@v4
      id: cache-nuget
      with:
        path: |
          ~/.nuget/packages
        key: >-
          ${{ runner.os }}-nuget-${{
            hashFiles(
              '**/NuGet.config',
              '**/Directory.Packages.props',
              '**/packages.lock.json'
            )
          }}
        restore-keys: |
          ${{ runner.os }}-nuget-

    - name: Restore NuGet packages
      #if: steps.cache-nuget.outputs.cache-hit != 'true'
      run: dotnet restore

    - name: Build Debug
      run: >
        dotnet build
        --no-restore
        --configuration Debug
        /bl:${{ env.logs_dir }}/build-debug.binlog

    - name: Build Release & pack
      run: >
        dotnet build
        --no-restore
        --configuration Release
        /p:ReleaseUrl="${{ steps.git-version.outputs.release-url }}"
        /p:ReleaseNotes="${{ steps.git-version.outputs.release-notes }}"
        /p:VersionSuffix="${{ steps.git-version.outputs.version-suffix }}"
        /bl:${{ env.logs_dir }}/build-release.binlog

    - name: 'Upload build artifacts: testing'
      uses: actions/upload-artifact@v4
      with:
        name: testing
        path: |
          ${{ env.artifacts_dir }}/debug*/
          ${{ env.artifacts_dir }}/obj/
          !**/*.resources.dll
          !**/*.xml
          !**/*.cache
          !**/Microsoft.*.pdb
        if-no-files-found: 'error'
        retention-days: 1

    - name: 'Upload build artifacts: packages'
      uses: actions/upload-artifact@v4
      with:
        name: packages
        path: ${{ env.packages_dir }}/release/
        compression-level: 0
        if-no-files-found: 'error'

    - name: Calculate next steps
      if: always()
      id: next
      run: >
        @{
          'publish-myget' = @{
            auto = $${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
            yes = $true
            no = $false
          }[$env:publish_myget]
          'publish-nuget' = @{
            auto = $${{ startsWith(github.ref, 'refs/tags/v') }}
            yes = $true
            no = $false
          }[$env:publish_nuget]
          'publish-log' = @{
            auto = $${{ job.status == 'failure' }}
            yes = $true
            no = $false
          }[$env:publish_log]
        } | ConvertTo-GitHubOutput >> $env:GITHUB_OUTPUT

    - name: 'Upload build artifacts: logs'
      if: steps.next.outputs.publish-log == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: logs
        path: ${{ env.logs_dir }}/
        compression-level: 0
        if-no-files-found: 'error'

    - name: Dump context
      if: always()
      env:
        github: ${{ toJson(github) }}
        inputs: ${{ toJson(inputs) }}
        job:    ${{ toJson(job) }}
        runner: ${{ toJson(runner) }}
        steps:  ${{ toJson(steps) }}
        vars:   ${{ toJson(vars) }}
      run: ''

  test:
    needs: build
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-latest
          - windows-latest

    steps:
    - name: Checkout Git repository (shallow)
      uses: actions/checkout@v5
      with:
        fetch-depth: 1
        submodules: true
        show-progress: false

    - name: Setup environment
      uses: ./.github/actions/setup
      if: matrix.os == 'ubuntu-latest'
      with:
        dotnet-version: ${{ env.dotnet_test_versions_core }}
        dotnet-runtime: dotnet

    - name: 'Download build artifacts: testing'
      uses: actions/download-artifact@v4
      with:
        name: testing
        path: ${{ env.artifacts_dir }}/

    - name: Run tests
      run: >
        dotnet test
        --no-restore --no-build
        /p:IsTestRunning=true
        --configuration Debug

    - name: 'Upload build artifacts: test results'
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results-${{ matrix.os }}
        path: ${{ env.tests_dir }}/

  failure:
    needs: [ build, test ]
    if: failure() && github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
    - name: Determine failure reason
      id: failure-reason
      run: |
        $failure = '${{ needs.test.result }}' -eq 'failure' ? 'tests' : 'build'
        @{
          'failure-label' = "check:$failure-failed"
        } | ConvertTo-GitHubOutput >> $env:GITHUB_OUTPUT

    - name: Label PR
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.addLabels({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            labels: [ '${{ steps.failure-reason.outputs.failure-label }}' ]
          })

  publish-myget:
    needs: [ build, test ]
    if: success() && needs.build.outputs.publish-myget == 'true'
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Git repository (shallow)
      uses: actions/checkout@v5
      with:
        fetch-depth: 1
        submodules: true
        show-progress: false

    - name: Download packages, Publish to MyGet
      uses: ./.github/actions/publish-nuget
      with:
        artifact-name: packages
        artifact-path: ${{ env.packages_dir }}/release/
        source: ${{ vars.MYGET_SOURCE }}
        api-key: ${{ secrets.MYGET_KEY }}

  publish-nuget:
    needs: [ build, test ]
    if: success() && needs.build.outputs.publish-nuget == 'true'
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Git repository (shallow)
      uses: actions/checkout@v5
      with:
        fetch-depth: 1
        submodules: true
        show-progress: false

    - name: Download packages, Publish to MyGet
      uses: ./.github/actions/publish-nuget
      with:
        artifact-name: packages
        artifact-path: ${{ env.packages_dir }}/release/
        source: ${{ vars.NUGET_SOURCE }}
        api-key: ${{ secrets.NUGET_KEY }}

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ github.ref_name }}
        name: Release ${{ github.ref_name }}
        prerelease: ${{ needs.build.outputs.prerelease }}
        generate_release_notes: true
        draft: false
        files: |
          ${{ env.packages_dir }}/release/*